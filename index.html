<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="我心中有猛虎，细嗅蔷薇">
<meta property="og:url" content="http://jemesl.github.io/index.html">
<meta property="og:site_name" content="我心中有猛虎，细嗅蔷薇">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="我心中有猛虎，细嗅蔷薇">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://jemesl.github.io/"/>





  <title>我心中有猛虎，细嗅蔷薇</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">我心中有猛虎，细嗅蔷薇</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jemesl.github.io/2018/09/20/runloop/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jemesl Wu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我心中有猛虎，细嗅蔷薇">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/20/runloop/" itemprop="url">runloop</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-20T14:13:03+08:00">
                2018-09-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="runloop相关的应用"><a href="#runloop相关的应用" class="headerlink" title="runloop相关的应用"></a>runloop相关的应用</h3><h4 id="滑动列表的优化"><a href="#滑动列表的优化" class="headerlink" title="滑动列表的优化"></a>滑动列表的优化</h4><p>cell中设置图片 会卡顿以下，可以吧设置image的代码放置在runloop default 的mode里运行。<br>避免滑动的过程中去触发设置image的动作。</p>
<h4 id="app-Crash-的优化"><a href="#app-Crash-的优化" class="headerlink" title="app Crash 的优化"></a>app Crash 的优化</h4><p>crash后 可以重新唤醒一个app 做一些提示性的文字 发送报错邮件等</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jemesl.github.io/2018/09/14/rxswift/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jemesl Wu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我心中有猛虎，细嗅蔷薇">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/14/rxswift/" itemprop="url">rxswift 的学习记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-14T11:40:14+08:00">
                2018-09-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近新的项目采用了rxswift + mvvm 来写。<br>网络框架用的moya 的rxswift版。</p>
<p>总的体验来说，mvvm架构中，确定体会到了把数据逻辑剥离出来并且方便复用的便利，。<br>采用了响应式编程理念，用了rxswift。在某些场景下，rxswift 的体验非常好.<br>不过现在也造成了在问题追踪上会比较麻烦。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jemesl.github.io/2018/09/13/WkWebview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jemesl Wu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我心中有猛虎，细嗅蔷薇">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/13/WkWebview/" itemprop="url">WkWebview与其他组件混排</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-13T15:47:55+08:00">
                2018-09-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>根据项目需求，需要多个webview和自定义的组件根据 API 返回数据动态混排。<br>并且需要针对css以及图片懒加载优化。</p>
<h3 id="一、添加css"><a href="#一、添加css" class="headerlink" title="一、添加css"></a>一、添加css</h3><p>这一点比较简单，webview所显示的内容是通过接口返回获得的字符串。<br>做一个简单的拼接就可以。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> link = <span class="string">"&lt;link rel=\"stylesheet\" href=\"<span class="subst">\(String(describing: Bundle.main.url(forResource: "RichStyle", withExtension: "css")</span>!))\"&gt;"</span></span><br><span class="line"><span class="keyword">let</span> htmlContent = <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">&lt;header&gt;</span></span><br><span class="line"><span class="string">&lt;meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no' /&gt;</span></span><br><span class="line"><span class="string"><span class="subst">\(link)</span></span></span><br><span class="line"><span class="string">&lt;/header&gt;</span></span><br><span class="line"><span class="string">&lt;div class='richtext-container'&gt;</span></span><br><span class="line"><span class="string"><span class="subst">\(newContent)</span></span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>
<p><strong>newContent</strong> 是内容正文<br><strong>link</strong> 是css样式<br>其中由于显示问题，需要在头部添加 <strong>meta</strong> 这一段。<br>由于css比较多，放在一起不太合适。可以写在另一个文件中，通过 <strong>Bundle</strong> 形式加载。<br>这里有个需要注意的地方，css文件存放的位置。<br>此刻RichStyle.css 存放在/Classes/Utils/ 下。<br>要在加载html 时，指定在 <strong>file:///Classes/Utils/</strong> 目录下。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webView.loadHTMLString(htmlContent, baseURL: <span class="type">URL</span>(string: <span class="string">"file:///Classes/Utils/"</span>) )</span><br></pre></td></tr></table></figure></p>
<h3 id="二、图片懒加载"><a href="#二、图片懒加载" class="headerlink" title="二、图片懒加载"></a>二、图片懒加载</h3><p>如果是单个webview，且视窗大小固定。可以使用 <strong>lazysizes</strong>，纯js原生，不依赖任何其他库。<br><strong>lazysizes</strong> 的逻辑是webview 视窗之外的图片懒加载，滑动到视窗的img 才会加载。<br>但项目中是多个webview 及其他组件 全展开显示在scrollview里面。<br>webview 视窗高度根据内容高度来的。导致 <strong>lazysizes</strong>依旧还是在加载同时把所有页面图片加载完，不过加载图片是在 <strong>didFinish</strong>之后。</p>
<p>目前的解决办法就是：</p>
<ul>
<li>拿到数据后对其中img标签作调整，将src 的值替换到 data-src中，这样没有src 则图片不会加载。或者给src设置一个占位图片的值也可以，并设置好大小。</li>
<li>在scrollview 中针对滚动代理方法优化，让页面停止下来时才开始触发加载图片的方法。</li>
<li>触发的方法 会让scrollview中 所有的webview 调用 判断是否加载图片的js脚本。并且会传入当前scrollview的contentOffset 和 webview的frame.minY</li>
<li>js脚本拿到当前webview 当中所有的imgs，遍历每一个img，并根据img的topoff 和webview 的偏移参数计算这个img 是否是在scrollview的视窗内。</li>
<li>然后判断修改img的src 加载图片。</li>
<li>还有点就是要刷新webview的高度, 可以在加载图片后 js 调swift 刷新高度，或者弄个定时器执行js脚本刷新高度</li>
</ul>
<h5 id="一、停止滚动触发监测加载图片的方法"><a href="#一、停止滚动触发监测加载图片的方法" class="headerlink" title="一、停止滚动触发监测加载图片的方法"></a>一、停止滚动触发监测加载图片的方法</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">scrollViewDidEndDragging</span><span class="params">(<span class="number">_</span> scrollView: UIScrollView, willDecelerate decelerate: Bool)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> !decelerate &#123;</span><br><span class="line">        <span class="keyword">let</span> dragTpDragStop = scrollView.isTracking &amp;&amp; !scrollView.isDragging &amp;&amp; !scrollView.isDecelerating</span><br><span class="line">        <span class="keyword">if</span> dragTpDragStop &#123;</span><br><span class="line">            scrollViewDidEndScroll()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">scrollViewDidEndDecelerating</span><span class="params">(<span class="number">_</span> scrollView: UIScrollView)</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> scrollToScrollStop = !scrollView.isTracking &amp;&amp; !scrollView.isDragging &amp;&amp; !scrollView.isDecelerating</span><br><span class="line">    <span class="keyword">if</span> scrollToScrollStop &#123;</span><br><span class="line">        scrollViewDidEndScroll()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">scrollViewDidEndScroll</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> scrollOffset = scrollView.contentOffset.y</span><br><span class="line">    <span class="keyword">for</span> rh <span class="keyword">in</span> allRichText.enumerated() &#123;<span class="comment">// rh 是一个包含 webview属性的组件</span></span><br><span class="line">        rh.element.loadImgsScript(offset:scrollOffset, wkTop: rh.element.frame.minY)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="二、执行每个webview的JS脚本"><a href="#二、执行每个webview的JS脚本" class="headerlink" title="二、执行每个webview的JS脚本"></a>二、执行每个webview的JS脚本</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loadImgsScript</span><span class="params">(offset: CGFloat, wkTop: CGFloat)</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> minOffset = offset</span><br><span class="line">    <span class="keyword">let</span> maxOffset = offset + bmy_screenHeight</span><br><span class="line">    <span class="keyword">let</span> script = <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">        var imgs = document.getElementsByTagName('img');</span></span><br><span class="line"><span class="string">        var minOffset = <span class="subst">\(minOffset)</span></span></span><br><span class="line"><span class="string">        var maxOffset = <span class="subst">\(maxOffset)</span></span></span><br><span class="line"><span class="string">        var wkTop = <span class="subst">\(wkTop)</span></span></span><br><span class="line"><span class="string">        function lazyload()&#123;</span></span><br><span class="line"><span class="string">            for(var i=0; i&lt;imgs.length; i++) &#123;</span></span><br><span class="line"><span class="string">                var img = imgs[i]</span></span><br><span class="line"><span class="string">                var top = img.offsetTop + wkTop</span></span><br><span class="line"><span class="string">                var isDisplay = false</span></span><br><span class="line"><span class="string">                if((top &gt; minOffset - 300) &amp;&amp; top &lt; maxOffset + 300) &#123;</span></span><br><span class="line"><span class="string">                    isDisplay = true</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                if(isDisplay)&#123;</span></span><br><span class="line"><span class="string">                    img.src = img.getAttribute('data-src');</span></span><br><span class="line"><span class="string">                    img.setAttribute('class','lazyloaded');</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        lazyload()</span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span></span><br><span class="line">    webView.evaluateJavaScript(script) &#123; (res, error) <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> e = error &#123;</span><br><span class="line">            <span class="built_in">print</span>(error)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="刷新webview-的高度"><a href="#刷新webview-的高度" class="headerlink" title="刷新webview 的高度"></a>刷新webview 的高度</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">reloadWebviewHeight</span><span class="params">()</span></span> &#123;</span><br><span class="line">    webView.evaluateJavaScript(<span class="string">"document.body.scrollHeight"</span>) &#123; (value, error) <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> safeValue = value <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        <span class="keyword">let</span> height = <span class="type">CGFloat</span>(safeValue <span class="keyword">as</span>! <span class="type">CGFloat</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> height &gt; <span class="keyword">self</span>.contentHeight &#123;</span><br><span class="line">            <span class="keyword">self</span>.contentHeight = height</span><br><span class="line">            <span class="keyword">self</span>.webView.snp.updateConstraints(&#123; (make) <span class="keyword">in</span></span><br><span class="line">                make.height.equalTo(height)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jemesl.github.io/2018/09/13/WkWebview-JS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jemesl Wu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我心中有猛虎，细嗅蔷薇">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/13/WkWebview-JS/" itemprop="url">WkWebview 与 js 交互</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-13T11:50:38+08:00">
                2018-09-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近由于项目的原因，需要wkwebview 与 js 频繁的交互<br>主要有以下两种</p>
<ul>
<li>Content-Blocking Rules</li>
<li>调用wkwebview 的js执行脚本的方法</li>
<li>JS 调用 swift</li>
</ul>
<h3 id="一、Content-Blocking-Rules"><a href="#一、Content-Blocking-Rules" class="headerlink" title="一、Content-Blocking Rules"></a>一、Content-Blocking Rules</h3><p>如果是iOS11 之后的并且需求简单 wkwebview 提供了一个内容过滤规则的功能。可以简单处理一些操作。这个的好处是webview显示内容之前就可以处理。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> jsonString = <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">[&#123;</span></span><br><span class="line"><span class="string">    "</span>trigger<span class="string">":&#123;</span></span><br><span class="line"><span class="string">        "</span>url-<span class="built_in">filter</span><span class="string">": "</span>.*<span class="string">",</span></span><br><span class="line"><span class="string">        "</span>resource-type<span class="string">":["</span>document<span class="string">"]</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "</span>action<span class="string">":&#123;</span></span><br><span class="line"><span class="string">        "</span>type<span class="string">": "</span>css-display-<span class="keyword">none</span><span class="string">",</span></span><br><span class="line"><span class="string">        "</span>selector<span class="string">": "</span>.js-mp-info<span class="string">"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;]</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br><span class="line"><span class="keyword">if</span> #available(iOS <span class="number">11.0</span>, *) &#123;</span><br><span class="line">    <span class="type">WKContentRuleListStore</span>.<span class="keyword">default</span>().compileContentRuleList(forIdentifier: <span class="string">"demoRuleList"</span>, encodedContentRuleList: jsonString) &#123; (list, error) <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> contentRuleList = list <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        <span class="keyword">let</span> configuration = <span class="keyword">self</span>.webView.configuration</span><br><span class="line">        configuration.userContentController.add(contentRuleList)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> detailUrl = <span class="keyword">self</span>.detailUrl &#123;</span><br><span class="line">            <span class="keyword">self</span>.urlStr = detailUrl</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>url-filter 可以用正则匹配url 是否触发规则过滤<br>resource-type 是适用资源类型</p>
<ul>
<li>document</li>
<li>image</li>
<li>style-sheet</li>
<li>script</li>
<li>font</li>
<li>raw (Any untyped load, such as XMLHttpRequest)</li>
<li>svg-document</li>
<li>media</li>
<li>popup</li>
</ul>
<p>action type 是动作类型</p>
<ul>
<li><p>block<br>Tells the browser engine to abort loading the resource. If the resource was cached, the cache is ignored.</p>
</li>
<li><p>block-cookies<br>The engine strips all cookies from the header before sending the request to the server. Safari’s own privacy policy takes precedence, so that only cookies that would otherwise be accepted by the privacy policy can be blocked. Combining block-cookies and ignore-previous-rules will not override the browser’s privacy settings.</p>
</li>
<li><p>css-display-none<br>Hides elements of the page based on a CSS selector. A second action field, named selector, contains the selector list. Any element matching the selector list has its display property set to none, which hides it.</p>
</li>
<li><p>ignore-previous-rules<br>Previously triggered actions are not performed.</p>
</li>
<li><p>make-https<br>Changes a URL from http to https before making a server request. URLs with a specified port (other than the default port 80) and links using other protocols are not affected.</p>
</li>
</ul>
<p><a href="https://developer.apple.com/library/archive/documentation/Extensions/Conceptual/ContentBlockingRules/CreatingRules/CreatingRules.html" target="_blank" rel="noopener"><strong>Content-Blocking Rules</strong> Apple官方文档使用说明</a></p>
<h3 id="二、调用wkwebview-的js执行脚本的方法"><a href="#二、调用wkwebview-的js执行脚本的方法" class="headerlink" title="二、调用wkwebview 的js执行脚本的方法"></a>二、调用wkwebview 的js执行脚本的方法</h3><p>如果版本小于ios11，没有Content-Blocking Rules，或者规则不能满足需求。<br>也可以通过调用 <strong>wk.evaluateJavaScript</strong> 方法, 直接执行js。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> str = <span class="string">"$('.js-mp-info').remove();"</span></span><br><span class="line">webView.evaluateJavaScript(str, completionHandler: <span class="literal">nil</span>)</span><br></pre></td></tr></table></figure></p>
<p>JS代码除了直接写成string之外，也可以在另写在文件里，然后读取文件。<br>例如 JS相关代码写在 <strong>LoginJavaScript.js</strong> 文件里<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> jsHandler = <span class="string">""</span></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    jsHandler = <span class="keyword">try</span> <span class="type">String</span>(contentsOf: <span class="type">Bundle</span>.main.url(forResource: <span class="string">"LoginJavaScript"</span>, withExtension: <span class="string">"js"</span>)!, encoding: <span class="type">String</span>.<span class="type">Encoding</span>.utf8)</span><br><span class="line">&#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> wkScript = <span class="type">WKUserScript</span>.<span class="keyword">init</span>(source: jsHandler,</span><br><span class="line">                                  injectionTime: <span class="type">WKUserScriptInjectionTime</span>.atDocumentEnd,</span><br><span class="line">                                  forMainFrameOnly: <span class="literal">true</span>)</span><br><span class="line">config.userContentController.addUserScript(wkScript)</span><br><span class="line"><span class="keyword">let</span> wk = <span class="type">WKWebView</span>.<span class="keyword">init</span>(frame: .zero, configuration: config)</span><br></pre></td></tr></table></figure></p>
<h3 id="三、JS-调用-swift"><a href="#三、JS-调用-swift" class="headerlink" title="三、JS 调用 swift"></a>三、JS 调用 swift</h3><h4 id="预定义"><a href="#预定义" class="headerlink" title="预定义"></a>预定义</h4><p>wkwebview的 config 可以事先定义一些事件<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> config = <span class="type">WKWebViewConfiguration</span>()</span><br><span class="line">config.userContentController.add(<span class="keyword">self</span>, name: <span class="string">"eventOne"</span>)</span><br><span class="line">config.userContentController.add(<span class="keyword">self</span>, name: <span class="string">"eventTwo"</span>)</span><br></pre></td></tr></table></figure></p>
<h4 id="JS调用"><a href="#JS调用" class="headerlink" title="JS调用"></a>JS调用</h4><p>然后在JS 脚本里面调用<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webkit.messageHandlers.eventOne.postMessage(message);</span><br></pre></td></tr></table></figure></p>
<p>其中 <strong>eventOne</strong> 就是之前事先定义好的事件名字。<br><strong>message</strong> 就是 js 向 swift 传递的信息</p>
<h4 id="Swift-代理方法监听"><a href="#Swift-代理方法监听" class="headerlink" title="Swift 代理方法监听"></a>Swift 代理方法监听</h4><p>实现 <strong>WKScriptMessageHandler</strong> 下的一个代理方法，在方法里面监测到JS触发的预定义的事件<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">userContentController</span><span class="params">(<span class="number">_</span> userContentController: WKUserContentController, didReceive message: WKScriptMessage)</span></span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> message.name &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">"eventOne"</span>:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">"eventOne"</span>)</span><br><span class="line">      <span class="built_in">print</span>(message.body)<span class="comment">//js传来的信息</span></span><br><span class="line">  <span class="keyword">case</span> <span class="string">"eventTwo"</span>:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">"eventTwo"</span>)</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">"none"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jemesl.github.io/2018/09/12/iOS-constraints/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jemesl Wu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我心中有猛虎，细嗅蔷薇">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/12/iOS-constraints/" itemprop="url">iOS约束冲突警告解决办法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-12T15:49:50+08:00">
                2018-09-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在开发过程中经常会遇到页面显示正常，但依然还有冲突警告。<br>通常的原因有2个。</p>
<h3 id="一、cell-中的约束冲突"><a href="#一、cell-中的约束冲突" class="headerlink" title="一、cell 中的约束冲突"></a>一、cell 中的约束冲突</h3><p>在这种情况下，在 xcode 的控制台打印出得信息当中会单独拎出一条约束。<br>Will attempt to recover by breaking constraint 下面那一条</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Probably</span> at least one of the constraints <span class="keyword">in</span> the following list <span class="keyword">is</span> one you don't want. </span><br><span class="line"><span class="type">Try</span> this: </span><br><span class="line">    (<span class="number">1</span>) look at each constraint and <span class="keyword">try</span> to figure out which you don't expect; </span><br><span class="line">    (<span class="number">2</span>) <span class="built_in">find</span> the code that added the unwanted constraint or constraints and fix it. </span><br><span class="line">(</span><br><span class="line">    <span class="string">"&lt;SnapKit.LayoutConstraint:0x6040002a08a0@ChoiceArticleCell.swift#182 UIImageView:0x7fae99d49240.left == UIView:0x7fae99d55e70.left&gt;"</span>,</span><br><span class="line">    <span class="string">"&lt;SnapKit.LayoutConstraint:0x6040002a0900@ChoiceArticleCell.swift#182 UIImageView:0x7fae99d49240.top == UIView:0x7fae99d55e70.top&gt;"</span>,</span><br><span class="line">    <span class="string">"&lt;SnapKit.LayoutConstraint:0x6040002a0960@ChoiceArticleCell.swift#182 UIImageView:0x7fae99d49240.right == UIView:0x7fae99d55e70.right&gt;"</span>,</span><br><span class="line">    <span class="string">"&lt;SnapKit.LayoutConstraint:0x6040002a09c0@ChoiceArticleCell.swift#182 UIImageView:0x7fae99d49240.bottom == UIView:0x7fae99d55e70.bottom&gt;"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="type">Will</span> attempt to recover by breaking constraint </span><br><span class="line">&lt;<span class="type">SnapKit</span>.<span class="type">LayoutConstraint</span>:<span class="number">0x6040002a0a20</span>@<span class="type">ChoiceArticleCell</span>.swift#<span class="number">183</span> <span class="type">UIImageView</span>:<span class="number">0x7fae99d49240</span>.height == <span class="type">UIImageView</span>:<span class="number">0x7fae99d49240</span>.width * <span class="number">0.425531923770905</span>&gt;</span><br></pre></td></tr></table></figure>
<p>解决办法就是：将这条约束的 <strong>优先级降低</strong>。约束默认的优先级是1000。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make.height.equalTo(cover.snp.width).multipliedBy(<span class="number">1</span>/<span class="number">2.35</span>).priority(<span class="number">999</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="二、普通view里面-会出现-约束冲突"><a href="#二、普通view里面-会出现-约束冲突" class="headerlink" title="二、普通view里面 会出现 约束冲突"></a>二、普通view里面 会出现 约束冲突</h3><p>这种情况 通常是view的 <strong>translatesAutoresizingMaskIntoConstraints</strong>属性 导致<br>将其改为 false 可以解决问题<br>针对 view<br>如果使用 autulayout 就将 translatesAutoresizingMaskIntoConstraints 设为 false<br>如果不使用 autulayout 就将 translatesAutoresizingMaskIntoConstraints 设为 true<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.translatesAutoresizingMaskIntoConstraints = <span class="literal">false</span></span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Jemesl Wu" />
          <p class="site-author-name" itemprop="name">Jemesl Wu</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jemesl Wu</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
